---
title: "metaRbolomics dependencies"
author: "Steffen Neumann"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document: default
  pdf_document: default
---

```{r setup, cache=TRUE}
options("repos" = list(CRAN="http://cran.rstudio.com/"))

library(devtools)   # for revdp()
library(igraph)     # for graph_from_edgelist/( and simplify() )
library(visNetwork) # for visNetwork() and friends
library(networkD3)  # for saveNetwork()
library(webshot2)   # for webshot()
library(png)        # For displaying an image

```


```{r packages, cache=TRUE}

## Read package names from our tables in the review
##
reviewTables <- read.delim("AllMetaRbolomicsTables.csv", stringsAsFactors = FALSE)
reviewPkgs <- reviewTables[,"Package"]

pkgs <- reviewPkgs

el <- sapply(pkgs, function(pkg) {
  rd <- revdep(pkg, dependencies = c("Depends", "Imports", "LinkingTo"), 
               recursive = FALSE, ignore = NULL, bioconductor = TRUE)
  as.matrix(cbind(Package=rep(pkg, length.out=length(rd)), ReverseDep=rd))
})
el <- do.call(rbind, el)
```

In total, we were analysing `r length(pkgs)` packages.
For each package, this returns the set of packages in CRAN or BioC that depend on, import from or link to the package (i.e., its direct reverse dependencies) using the `devtools::revdep()` function. A few packages with the highest number of reverse dependencies have been excluded, as they would dominate the visualisation. 
It was not possible to detect reverse dependencies from other hosting places such as GitHub or GitLab. 

From the total, `r length(unique(el[,"Package"]))` packages had at least one 
such reverse dependency.

```{r revVisNetwork, cache=TRUE}

## Remove packages with most reverse dependencies 
## which would dominate the network

el <- el[! el[,"Package"] %in% c("Rcpp", "igraph", "vegan", "caret", "rJava"), ]

## Create graph, and simplify redundancy
g <- graph_from_edgelist(el, directed = TRUE)
g <- simplify(g, remove.multiple = TRUE, remove.loops = TRUE)

# get data and plot :
data <- toVisNetworkData(g)

data$nodes <- cbind(data$nodes, 
                    font.size=30, 
                    color.background = ifelse(data$nodes[,"id"] %in% pkgs , 
                           rgb(0, 0, 200, 128, max = 255), 
                           rgb(0, 200, 0, 128, max = 255)))

vn <- visNetwork(nodes = data$nodes, 
                 edges = data$edges,
                 width=1000, height=1000,
                 ) %>% 
  visPhysics(timestep = 0.3,
             barnesHut = list(centralGravity=0.35,
                              springLength = 95)) %>% 
  visOptions(highlightNearest = TRUE)

vn

```

In the above figure, the packages with reverse dependencies 
from the review are shown as blue nodes. Their (reverse) dependencies 
from CRAN and BioC are shown in green.

```{r fileVis}

saveNetwork(vn, "vn.html")
webshot("vn.html", "revDepNet-60.png", delay = 60)

```

The source code for this page is on GitHub at [github.com/sneumann/metaRbolomics](https://github.com/sneumann/metaRbolomics)

The HTML output is shown at 
[sneumann.github.io/metaRbolomics/revDepNet.html](https://sneumann.github.io/metaRbolomics/revDepNet.html)

and [sneumann.github.io/metaRbolomics/vn.html](https://sneumann.github.io/metaRbolomics/vn.html) (Caveat: long rendering time, blank page without any visible progress)

This page was created with the following packages:

```{r sessionInfo}
sessionInfo()
```
